function G1(D){D.innerHTML="";let F=document.createElement("div");F.className="header";let U=document.createElement("h1");U.textContent="Lithography Simulator";let J=document.createElement("span");J.className="subtitle",J.textContent="Fourier Optics / Aerial Image";let Q=document.createElement("button");Q.className="download-btn",Q.textContent="Export PNG",F.append(U,J,Q);let q=document.createElement("div");q.className="panel",q.dataset.panel="mask";let $=document.createElement("div");$.className="panel panel-heatmap",$.dataset.panel="view";let K=document.createElement("div");K.className="view-toggle";let G=document.createElement("button");G.textContent="Heatmap",G.classList.add("active");let Z=document.createElement("button");Z.textContent="Bossung",K.append(G,Z),$.appendChild(K);let _=document.createElement("div");_.className="heatmap-container";let H=document.createElement("canvas");_.appendChild(H),$.appendChild(_);let A=document.createElement("div");A.className="bossung-chart-container",A.style.display="none";let E=document.createElement("canvas");A.appendChild(E),$.appendChild(A);function L(R){let C=R==="heatmap";_.style.display=C?"":"none",A.style.display=C?"none":"flex",G.classList.toggle("active",C),Z.classList.toggle("active",!C)}G.addEventListener("click",()=>L("heatmap")),Z.addEventListener("click",()=>L("bossung")),A._showBossung=()=>L("bossung");let O=document.createElement("div");O.className="panel panel-params",O.dataset.panel="params";let M=document.createElement("div");M.className="panel-title",M.textContent="Parameters",O.appendChild(M);let Y=document.createElement("div");Y.className="timing-readout",Y.innerHTML=`
    FFT + Pupil: <span class="value" id="timing-sim">—</span> ms<br>
    Render: <span class="value" id="timing-render">—</span> ms
  `,O.appendChild(Y);let T=document.createElement("div");T.className="zoom-bar";let k=document.createElement("button");k.className="zoom-btn",k.textContent="−";let P=document.createElement("input");P.type="range",P.className="zoom-slider",P.min="0.5",P.max="4",P.step="0.1",P.value="1";let j=document.createElement("button");j.className="zoom-btn",j.textContent="+";let W=document.createElement("span");W.className="zoom-label",W.textContent="100%",T.append(k,P,j,W),_.appendChild(T);let w=document.createElement("div");w.className="mobile-tab-bar";let y=[{key:"mask",label:"Mask"},{key:"view",label:"View"},{key:"params",label:"Params"}],V=[];for(let R of y){let C=document.createElement("button");C.className="mobile-tab-btn",C.textContent=R.label,C.dataset.tab=R.key,C.addEventListener("click",()=>{D.dataset.activeTab=R.key;for(let S of V)S.classList.toggle("active",S.dataset.tab===R.key)}),V.push(C),w.appendChild(C)}return D.dataset.activeTab="view",V[1].classList.add("active"),D.append(F,q,$,O,w),{maskPanel:q,heatmapCanvas:H,paramsPanel:O,timingReadout:Y,zoomSlider:P,zoomInBtn:j,zoomOutBtn:k,zoomLabel:W,heatmapContainer:_,mobileTabBar:w,downloadBtn:Q,bossungCanvas:E,bossungChartContainer:A}}var Z1=[],F1=!1,l={wavelength:248,na:0.75,sigma:0.5,defocus:0},d={mask:new Float32Array(65536),params:{...l}};function D1(){if(F1)return;F1=!0,requestAnimationFrame(()=>{F1=!1;for(let D of Z1)D(d)})}function h(){return d}function _1(D){Z1.push(D)}function r(D){d.mask=D,D1()}function A1(D,F){d.params[D]=F,D1()}function j1(){Object.assign(d.params,l),D1()}function o(){return new Float32Array(65536)}function y1(){let D=o(),F=10,U=5;for(let J=0;J<256;J++)for(let Q=0;Q<256;Q++)if(Q%10<5)D[J*256+Q]=1;return D}function v1(){let D=o(),F=20,U=6,J=Math.floor(7);for(let Q=0;Q<256;Q++)for(let q=0;q<256;q++){let $=Q%20,K=q%20;if($>=J&&$<J+6&&K>=J&&K<J+6)D[Q*256+q]=1}return D}function z1(){let D=o(),F=6,U=125,J=131;for(let Q=0;Q<256;Q++)for(let q=125;q<131;q++)D[Q*256+q]=1;return D}function S1(){let D=o(),F=5,U=2;for(let J=0;J<256;J++)for(let Q=0;Q<256;Q++)if(Q%5<2)D[J*256+Q]=1;return D}function b1(){let D=o(),F=128,U=128,J=60,Q=10;for(let q=0;q<256;q++)for(let $=0;$<256;$++){let K=q-128,G=$-128,Z=G>=0&&G<60&&K>=-5&&K<5,_=K>=0&&K<60&&G>=-5&&G<5;if(Z||_)D[q*256+$]=1}return D}var E1=[{name:"line_space",label:"Line/Space (10px)",generate:y1},{name:"contacts",label:"Contact Holes",generate:v1},{name:"isolated_line",label:"Isolated Line",generate:z1},{name:"dense_lines",label:"Dense Lines (5px)",generate:S1},{name:"l_shape",label:"L-Shape Corner",generate:b1}];var B=256;function h1(D,F){let U=F/2,J=[],Q=Math.floor(F/2);switch(D){case"square":for(let q=-Q;q<=Q;q++)for(let $=-Q;$<=Q;$++)J.push([$,q]);break;case"circle":for(let q=-Q;q<=Q;q++)for(let $=-Q;$<=Q;$++)if($*$+q*q<=U*U)J.push([$,q]);break;case"ring":{let q=U*0.6;for(let $=-Q;$<=Q;$++)for(let K=-Q;K<=Q;K++){let G=K*K+$*$;if(G<=U*U&&G>=q*q)J.push([K,$])}break}case"cross":{let q=Math.max(1,Math.floor(F/6));for(let $=-Q;$<=Q;$++)for(let K=-Q;K<=Q;K++)if(Math.abs(K)<=q||Math.abs($)<=q)J.push([K,$]);break}case"lineH":{let q=Math.max(1,Math.floor(F/6));for(let $=-q;$<=q;$++)for(let K=-Q;K<=Q;K++)J.push([K,$]);break}case"lineV":{let q=Math.max(1,Math.floor(F/6));for(let $=-Q;$<=Q;$++)for(let K=-q;K<=q;K++)J.push([K,$]);break}}return J}var N1=[{key:"square",label:"Square"},{key:"circle",label:"Circle"},{key:"ring",label:"Ring"},{key:"cross",label:"Cross"},{key:"lineH",label:"Line H"},{key:"lineV",label:"Line V"}];function H1(D){let F=document.createElement("div");F.className="panel-title",F.textContent="Mask Editor",D.appendChild(F);let U=document.createElement("div");U.className="panel-mask",D.appendChild(U);let J=document.createElement("div");J.className="mask-canvas-wrap";let Q=document.createElement("canvas");Q.width=B,Q.height=B,J.appendChild(Q),U.appendChild(J);let q=Q.getContext("2d"),$="brush",K="square",G=20,Z=!1,_=1;function H(){let X=h().mask,I=q.createImageData(B,B),z=I.data;for(let v=0;v<B*B;v++){let b=X[v]>0?255:0;z[v*4]=b,z[v*4+1]=b,z[v*4+2]=b,z[v*4+3]=255}q.putImageData(I,0,0)}function A(X){let I=Q.getBoundingClientRect(),z=B/I.width,v=B/I.height,b=Math.floor((X.clientX-I.left)*z),f=Math.floor((X.clientY-I.top)*v);return[Math.max(0,Math.min(B-1,b)),Math.max(0,Math.min(B-1,f))]}function E(X,I,z){for(let v=-1;v<=1;v++)for(let b=-1;b<=1;b++){let f=X+b,x=I+v;if(f>=0&&f<B&&x>=0&&x<B)z[x*B+f]=_}}function L(X,I,z){let v=h1(K,G);for(let[b,f]of v){let x=X+b,U1=I+f;if(x>=0&&x<B&&U1>=0&&U1<B)z[U1*B+x]=_}}function O(X){let[I,z]=A(X),v=h().mask;if($==="stamp")L(I,z,v);else E(I,z,v);H(),r(v)}Q.style.touchAction="none",Q.addEventListener("pointerdown",(X)=>{Z=!0,_=X.button===2?0:1,Q.setPointerCapture(X.pointerId),O(X)}),Q.addEventListener("pointermove",(X)=>{if(Z)O(X)}),Q.addEventListener("pointerup",(X)=>{Z=!1,Q.releasePointerCapture(X.pointerId)}),Q.addEventListener("pointerleave",()=>{Z=!1}),Q.addEventListener("contextmenu",(X)=>X.preventDefault());let M=document.createElement("div");M.className="tool-toggle";let Y=document.createElement("button");Y.textContent="BRUSH",Y.classList.add("active");let T=document.createElement("button");T.textContent="STAMP";function k(X){$=X,Y.classList.toggle("active",X==="brush"),T.classList.toggle("active",X==="stamp"),P.style.display=X==="stamp"?"":"none"}Y.addEventListener("click",()=>k("brush")),T.addEventListener("click",()=>k("stamp")),M.append(Y,T),U.appendChild(M);let P=document.createElement("div");P.className="stamp-options",P.style.display="none";let j=document.createElement("div");j.className="stamp-shape-row";let W=[];for(let X of N1){let I=document.createElement("button");if(I.className="stamp-btn",I.textContent=X.label,X.key===K)I.classList.add("active");I.addEventListener("click",()=>{K=X.key,W.forEach((z)=>z.classList.remove("active")),I.classList.add("active")}),W.push(I),j.appendChild(I)}P.appendChild(j);let w=document.createElement("div");w.className="param-group";let y=document.createElement("div");y.className="param-label";let V=document.createElement("span");V.className="param-name",V.textContent="Stamp Size";let R=document.createElement("span");R.className="param-value",R.textContent=String(G),y.append(V,R);let C=document.createElement("input");C.type="range",C.min="4",C.max="60",C.value=String(G),C.addEventListener("input",()=>{G=Number(C.value),R.textContent=String(G)}),w.append(y,C),P.appendChild(w),U.appendChild(P);let S=document.createElement("div");S.className="preset-buttons";let u=null;for(let X of E1){let I=document.createElement("button");I.className="preset-btn",I.textContent=X.label,I.addEventListener("click",()=>{let z=X.generate();if(r(z),H(),u)u.classList.remove("active");I.classList.add("active"),u=I}),S.appendChild(I)}U.appendChild(S);let e=document.createElement("div");e.className="mask-tools";let t=document.createElement("button");t.textContent="CLEAR",t.addEventListener("click",()=>{if(r(new Float32Array(B*B)),H(),u)u.classList.remove("active");u=null});let a=document.createElement("button");return a.textContent="INVERT",a.addEventListener("click",()=>{let X=h().mask;for(let I=0;I<B*B;I++)X[I]=X[I]>0?0:1;r(X),H()}),e.append(t,a),U.appendChild(e),H(),{setDisplaySize(X){Q.style.width=X+"px",Q.style.height=X+"px"}}}var J1=[{label:"S",size:192},{label:"M",size:384},{label:"L",size:512},{label:"XL",size:768}];function f1(D){if(!Number.isFinite(D))return 128;return Math.round(Math.max(128,Math.min(768,D)))}function X1(D,F){let U=document.createElement("div");U.className="canvas-size-controls";let J=document.createElement("div");J.className="param-group";let Q=document.createElement("div");Q.className="param-label";let q=document.createElement("span");q.className="param-name",q.textContent="Canvas Size";let $=document.createElement("span");$.className="param-value";let K=document.createElement("span");K.className="param-unit",K.textContent="px";let G=document.createElement("span");G.append($,K),Q.append(q,G);let Z=document.createElement("input");Z.type="range",Z.min=String(128),Z.max=String(768),Z.step="1",Z.value=String(384),J.append(Q,Z),U.appendChild(J);let _=document.createElement("div");_.className="size-preset-row";let H=[];for(let M of J1){let Y=document.createElement("button");Y.className="stamp-btn",Y.textContent=M.label,Y.addEventListener("click",()=>O(M.size)),H.push(Y),_.appendChild(Y)}U.appendChild(_);let A=document.createElement("div");A.className="size-input-row";let E=document.createElement("input");E.type="number",E.className="size-text-input",E.min=String(128),E.max=String(768),E.value=String(384);let L=document.createElement("span");L.className="param-unit",L.textContent="px",E.addEventListener("change",()=>{O(Number(E.value))}),A.append(E,L),U.appendChild(A),D.appendChild(U);function O(M){let Y=f1(M);Z.value=String(Y),$.textContent=String(Y),E.value=String(Y);for(let T=0;T<J1.length;T++)H[T].classList.toggle("active",J1[T].size===Y);F(Y)}Z.addEventListener("input",()=>{O(Number(Z.value))}),O(384)}var x1=[{key:"wavelength",label:"Wavelength",unit:"nm",min:193,max:365,step:1,decimals:0},{key:"na",label:"NA",unit:"",min:0.1,max:1.4,step:0.01,decimals:2},{key:"sigma",label:"Sigma (σ)",unit:"",min:0,max:1,step:0.01,decimals:2},{key:"defocus",label:"Defocus",unit:"μm",min:-2,max:2,step:0.01,decimals:2}];function Y1(D){let F=[];for(let J of x1){let Q=document.createElement("div");Q.className="param-group";let q=document.createElement("div");q.className="param-label";let $=document.createElement("span");$.className="param-name",$.textContent=J.label;let K=document.createElement("span"),G=document.createElement("span");G.className="param-value";let Z=document.createElement("span");Z.className="param-unit",Z.textContent=J.unit,K.append(G,Z),q.append($,K);let _=document.createElement("input");_.type="range",_.min=String(J.min),_.max=String(J.max),_.step=String(J.step),_.value=String(h().params[J.key]);let H=(A)=>{G.textContent=A.toFixed(J.decimals)};H(h().params[J.key]),_.addEventListener("input",()=>{let A=parseFloat(_.value);H(A),A1(J.key,A)}),Q.append(q,_),D.appendChild(Q),F.push({def:J,input:_,updateDisplay:H})}let U=document.createElement("button");U.className="reset-params-btn",U.textContent="Reset Defaults",U.addEventListener("click",()=>{j1();for(let{def:J,input:Q,updateDisplay:q}of F){let $=l[J.key];Q.value=String($),q($)}}),D.appendChild(U)}var W1=[{key:"focusSteps",label:"Focus Steps",unit:"",min:5,max:21,step:2,decimals:0,defaultValue:11},{key:"doseMin",label:"Dose Min",unit:"",min:0.5,max:1.5,step:0.05,decimals:2,defaultValue:0.7},{key:"doseMax",label:"Dose Max",unit:"",min:0.5,max:1.5,step:0.05,decimals:2,defaultValue:1.3},{key:"doseSteps",label:"Dose Steps",unit:"",min:3,max:9,step:1,decimals:0,defaultValue:7}];function L1(D,F){let U=document.createElement("div");U.className="bossung-section";let J=document.createElement("div");J.className="panel-title",J.style.padding="0 0 8px",J.style.border="none",J.textContent="Process Window",U.appendChild(J);let Q=document.createElement("div");Q.className="param-label",Q.style.marginBottom="8px";let q=document.createElement("span");q.className="param-name",q.textContent="Focus Range";let $=document.createElement("span");$.innerHTML='<span class="param-value">-2.0</span> to <span class="param-value">+2.0</span> <span class="param-unit">μm</span>',Q.append(q,$),U.appendChild(Q);let K={};for(let A of W1)K[A.key]=A.defaultValue;for(let A of W1){let E=document.createElement("div");E.className="param-group";let L=document.createElement("div");L.className="param-label";let O=document.createElement("span");O.className="param-name",O.textContent=A.label;let M=document.createElement("span"),Y=document.createElement("span");Y.className="param-value",Y.textContent=A.defaultValue.toFixed(A.decimals);let T=document.createElement("span");T.className="param-unit",T.textContent=A.unit,M.append(Y,T),L.append(O,M);let k=document.createElement("input");k.type="range",k.min=String(A.min),k.max=String(A.max),k.step=String(A.step),k.value=String(A.defaultValue),k.addEventListener("input",()=>{let P=parseFloat(k.value);K[A.key]=P,Y.textContent=P.toFixed(A.decimals)}),E.append(L,k),U.appendChild(E)}let G=document.createElement("button");G.className="bossung-run-btn",G.textContent="Run Bossung Analysis",G.addEventListener("click",()=>{let A={focusRange:[-2,2],focusSteps:K.focusSteps,doseRange:[K.doseMin,K.doseMax],doseSteps:K.doseSteps};F(A)}),U.appendChild(G);let Z=document.createElement("div");Z.className="bossung-timing",Z.innerHTML='Sweep: <span class="value">--</span> ms (<span class="value bossung-runs">--</span> runs)',U.appendChild(Z),D.appendChild(U);let _=Z.querySelector(".value"),H=Z.querySelector(".bossung-runs");return{setTiming(A,E){_.textContent=A.toFixed(1),H.textContent=String(E)},setRunning(A){G.disabled=A,G.textContent=A?"Running…":"Run Bossung Analysis"}}}var O1=`#version 300 es
precision highp float;

// Fullscreen triangle trick — 3 vertices, no buffers needed
const vec2 positions[3] = vec2[3](
  vec2(-1.0, -1.0),
  vec2( 3.0, -1.0),
  vec2(-1.0,  3.0)
);

out vec2 vUV;

void main() {
  vec2 pos = positions[gl_VertexID];
  vUV = pos * 0.5 + 0.5;
  gl_Position = vec4(pos, 0.0, 1.0);
}
`,V1=`#version 300 es
precision highp float;

uniform sampler2D uIntensity;  // R32F intensity data
uniform sampler2D uColormap;   // 256x1 RGBA viridis lookup

in vec2 vUV;
out vec4 fragColor;

void main() {
  float val = texture(uIntensity, vUV).r;
  val = clamp(val, 0.0, 1.0);
  fragColor = texture(uColormap, vec2(val, 0.5));
}
`;var g1=[[68,1,84],[68,2,86],[69,4,87],[69,5,89],[70,7,90],[70,8,92],[70,10,93],[70,11,94],[71,13,96],[71,14,97],[71,16,99],[71,17,100],[71,19,101],[72,20,103],[72,22,104],[72,23,105],[72,24,106],[72,26,108],[72,27,109],[72,28,110],[72,29,111],[72,31,112],[72,32,113],[72,33,115],[72,35,116],[72,36,117],[72,37,118],[72,38,119],[72,40,120],[72,41,121],[71,42,122],[71,44,122],[71,45,123],[71,46,124],[71,47,125],[70,48,126],[70,50,126],[70,51,127],[69,52,128],[69,53,129],[69,55,129],[68,56,130],[68,57,131],[68,58,131],[67,60,132],[67,61,132],[66,62,133],[66,63,133],[66,64,134],[65,66,134],[65,67,135],[64,68,135],[64,69,136],[63,71,136],[63,72,137],[62,73,137],[62,74,137],[62,76,138],[61,77,138],[61,78,138],[60,79,139],[60,80,139],[59,82,139],[59,83,140],[58,84,140],[58,85,140],[57,86,140],[57,87,141],[56,88,141],[56,90,141],[55,91,141],[55,92,141],[54,93,141],[54,94,142],[53,95,142],[53,96,142],[52,97,142],[52,98,142],[51,99,142],[51,100,142],[50,101,142],[50,102,142],[49,103,142],[49,104,142],[49,105,142],[48,106,142],[48,107,142],[47,108,142],[47,109,142],[46,110,142],[46,111,142],[46,112,142],[45,113,142],[45,114,142],[44,115,142],[44,116,141],[44,117,141],[43,118,141],[43,119,141],[42,120,141],[42,121,141],[42,122,141],[41,123,140],[41,124,140],[40,125,140],[40,126,140],[40,127,140],[39,128,139],[39,129,139],[39,130,139],[38,131,139],[38,132,139],[37,133,138],[37,134,138],[37,135,138],[36,136,138],[36,137,137],[36,138,137],[35,139,137],[35,140,136],[35,141,136],[34,142,136],[34,143,135],[34,144,135],[33,145,135],[33,146,134],[33,147,134],[33,148,133],[32,149,133],[32,150,133],[32,151,132],[32,152,132],[31,153,131],[31,154,131],[31,155,130],[31,156,130],[31,157,129],[31,158,129],[30,159,128],[30,160,128],[30,161,127],[30,162,127],[30,163,126],[30,164,126],[30,165,125],[30,166,124],[30,167,124],[31,168,123],[31,169,123],[31,170,122],[31,171,121],[31,172,121],[32,173,120],[32,174,119],[33,175,119],[33,176,118],[33,177,117],[34,178,117],[34,179,116],[35,180,115],[35,181,114],[36,182,114],[36,183,113],[37,184,112],[38,185,111],[38,186,111],[39,187,110],[40,188,109],[41,189,108],[41,190,107],[42,191,106],[43,192,106],[44,193,105],[45,194,104],[46,195,103],[47,196,102],[48,197,101],[49,198,100],[50,199,99],[52,200,98],[53,201,97],[54,202,96],[56,203,95],[57,204,94],[59,205,93],[60,206,92],[62,207,91],[63,208,90],[65,209,89],[67,210,87],[68,210,86],[70,211,85],[72,212,84],[74,213,83],[75,214,81],[77,214,80],[79,215,79],[81,216,78],[83,217,76],[85,217,75],[87,218,74],[89,219,72],[91,219,71],[93,220,70],[95,221,68],[97,221,67],[99,222,65],[101,222,64],[104,223,63],[106,223,61],[108,224,60],[110,224,58],[112,225,57],[115,225,55],[117,226,54],[119,226,52],[121,227,51],[124,227,49],[126,228,48],[128,228,46],[131,229,45],[133,229,43],[135,229,42],[138,230,40],[140,230,39],[142,231,37],[145,231,36],[147,231,34],[150,232,33],[152,232,31],[155,232,30],[157,233,28],[159,233,27],[162,233,25],[164,234,24],[167,234,23],[169,234,21],[172,235,20],[174,235,19],[177,235,18],[179,235,17],[182,236,16],[184,236,15],[187,236,14],[189,236,14],[192,237,13],[194,237,13],[197,237,13],[199,237,13],[201,237,13],[204,238,14],[206,238,14],[209,238,15],[211,238,16],[213,238,17],[216,239,18]];function I1(){let D=new Uint8Array(1024);for(let F=0;F<256;F++){let U=g1[F];D[F*4+0]=U[0],D[F*4+1]=U[1],D[F*4+2]=U[2],D[F*4+3]=255}return D}var N=256;class Q1{gl;program;intensityTex;colormapTex;vao;constructor(D){D.width=N,D.height=N;let F=D.getContext("webgl2",{antialias:!1,alpha:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!0});if(!F)throw Error("WebGL2 not supported");this.gl=F;let U=F.getExtension("EXT_color_buffer_float");this.program=this.createProgram(O1,V1),this.vao=F.createVertexArray(),this.intensityTex=F.createTexture(),F.bindTexture(F.TEXTURE_2D,this.intensityTex),F.texParameteri(F.TEXTURE_2D,F.TEXTURE_MIN_FILTER,F.NEAREST),F.texParameteri(F.TEXTURE_2D,F.TEXTURE_MAG_FILTER,F.NEAREST),F.texParameteri(F.TEXTURE_2D,F.TEXTURE_WRAP_S,F.CLAMP_TO_EDGE),F.texParameteri(F.TEXTURE_2D,F.TEXTURE_WRAP_T,F.CLAMP_TO_EDGE),F.texImage2D(F.TEXTURE_2D,0,F.R32F,N,N,0,F.RED,F.FLOAT,null),this.colormapTex=F.createTexture(),F.bindTexture(F.TEXTURE_2D,this.colormapTex),F.texParameteri(F.TEXTURE_2D,F.TEXTURE_MIN_FILTER,F.LINEAR),F.texParameteri(F.TEXTURE_2D,F.TEXTURE_MAG_FILTER,F.LINEAR),F.texParameteri(F.TEXTURE_2D,F.TEXTURE_WRAP_S,F.CLAMP_TO_EDGE),F.texParameteri(F.TEXTURE_2D,F.TEXTURE_WRAP_T,F.CLAMP_TO_EDGE);let J=I1();F.texImage2D(F.TEXTURE_2D,0,F.RGBA,256,1,0,F.RGBA,F.UNSIGNED_BYTE,J),F.useProgram(this.program),F.uniform1i(F.getUniformLocation(this.program,"uIntensity"),0),F.uniform1i(F.getUniformLocation(this.program,"uColormap"),1)}draw(D){let F=this.gl;F.activeTexture(F.TEXTURE0),F.bindTexture(F.TEXTURE_2D,this.intensityTex),F.texSubImage2D(F.TEXTURE_2D,0,0,0,N,N,F.RED,F.FLOAT,D),F.activeTexture(F.TEXTURE1),F.bindTexture(F.TEXTURE_2D,this.colormapTex),F.useProgram(this.program),F.bindVertexArray(this.vao),F.viewport(0,0,N,N),F.drawArrays(F.TRIANGLES,0,3)}resize(D,F){}createProgram(D,F){let U=this.gl,J=this.compileShader(U.VERTEX_SHADER,D),Q=this.compileShader(U.FRAGMENT_SHADER,F),q=U.createProgram();if(U.attachShader(q,J),U.attachShader(q,Q),U.linkProgram(q),!U.getProgramParameter(q,U.LINK_STATUS)){let $=U.getProgramInfoLog(q);throw U.deleteProgram(q),Error("Shader link error: "+$)}return U.deleteShader(J),U.deleteShader(Q),q}compileShader(D,F){let U=this.gl,J=U.createShader(D);if(U.shaderSource(J,F),U.compileShader(J),!U.getShaderParameter(J,U.COMPILE_STATUS)){let Q=U.getShaderInfoLog(J);throw U.deleteShader(J),Error("Shader compile error: "+Q)}return J}}var i=["#58a6ff","#3fb950","#f0883e","#bc8cff","#f778ba","#ffd33d","#a5d6ff","#ff7b72","#7ee787"];var c={top:40,right:130,bottom:55,left:70};class $1{canvas;ctx;constructor(D){this.canvas=D,this.ctx=D.getContext("2d")}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(D){let F=this.canvas,U=this.ctx,J=window.devicePixelRatio||1,Q=F.getBoundingClientRect(),q=Q.width,$=Q.height;F.width=q*J,F.height=$*J,U.setTransform(J,0,0,J,0,0);let{left:K,top:G}=c,Z=q-c.left-c.right,_=$-c.top-c.bottom;if(Z<40||_<40)return;let H=D.focusValues[0],A=D.focusValues[D.focusValues.length-1],E=1/0,L=-1/0;for(let j of D.curves)for(let W of j.points){if(W.cd<E)E=W.cd;if(W.cd>L)L=W.cd}if(!isFinite(E)||!isFinite(L)||E===L)E=0,L=200;else{let j=(L-E)*0.1||20;E=Math.max(0,E-j),L=L+j}let O=(j)=>K+(j-H)/(A-H)*Z,M=(j)=>G+_-(j-E)/(L-E)*_;U.fillStyle="#161b22",U.fillRect(0,0,q,$),U.font='10px "SF Mono", "Cascadia Code", "Fira Code", monospace',U.textAlign="center",U.textBaseline="top";let Y=T1(H,A,8),T=T1(E,L,6);U.strokeStyle="rgba(48, 54, 61, 0.6)",U.lineWidth=1,U.setLineDash([4,4]);for(let j of Y){let W=O(j);U.beginPath(),U.moveTo(W,G),U.lineTo(W,G+_),U.stroke(),U.fillStyle="#8b949e",U.fillText(j.toFixed(1),W,G+_+8)}U.textAlign="right",U.textBaseline="middle";for(let j of T){let W=M(j);U.beginPath(),U.moveTo(K,W),U.lineTo(K+Z,W),U.stroke(),U.fillStyle="#8b949e",U.fillText(j.toFixed(0),K-8,W)}U.setLineDash([]),U.strokeStyle="rgba(48, 54, 61, 0.6)",U.lineWidth=1,U.strokeRect(K,G,Z,_);for(let j=0;j<D.curves.length;j++){let W=D.curves[j],w=i[j%i.length];U.strokeStyle=w,U.lineWidth=2,U.lineJoin="round",U.lineCap="round",U.beginPath();for(let y=0;y<W.points.length;y++){let V=W.points[y],R=O(V.focus),C=M(V.cd);if(y===0)U.moveTo(R,C);else U.lineTo(R,C)}U.stroke(),U.fillStyle=w;for(let y of W.points)U.beginPath(),U.arc(O(y.focus),M(y.cd),3,0,Math.PI*2),U.fill()}U.fillStyle="#8b949e",U.font='11px "SF Mono", "Cascadia Code", "Fira Code", monospace',U.textAlign="center",U.textBaseline="top",U.fillText("Defocus (μm)",K+Z/2,G+_+30),U.save(),U.translate(16,G+_/2),U.rotate(-Math.PI/2),U.textAlign="center",U.textBaseline="middle",U.fillText("CD (nm)",0,0),U.restore(),U.fillStyle="#e6edf3",U.font='12px "SF Mono", "Cascadia Code", "Fira Code", monospace',U.textAlign="center",U.textBaseline="top",U.fillText("Bossung Curves",K+Z/2,12);let k=K+Z+16,P=G+4;U.font='10px "SF Mono", "Cascadia Code", "Fira Code", monospace',U.textAlign="left",U.textBaseline="middle";for(let j=0;j<D.curves.length;j++){let W=i[j%i.length],w=D.doseValues[j];U.strokeStyle=W,U.lineWidth=2,U.beginPath(),U.moveTo(k,P),U.lineTo(k+18,P),U.stroke(),U.fillStyle="#8b949e",U.fillText(`D=${w.toFixed(2)}`,k+24,P),P+=18}}}function T1(D,F,U){let J=F-D;if(J<=0)return[D];let Q=J/U,q=Math.pow(10,Math.floor(Math.log10(Q))),$,K=Q/q;if(K<=1.5)$=q;else if(K<=3.5)$=2*q;else if(K<=7.5)$=5*q;else $=10*q;let G=[],Z=Math.ceil(D/$)*$;for(let _=Z;_<=F+$*0.01;_+=$)G.push(Math.round(_/$)*$);return G}function u1(D,F){let U=0;for(let J=0;J<F;J++)U=U<<1|D&1,D>>=1;return U}function c1(D){let F=Math.log2(D)|0,U=new Uint32Array(D);for(let J=0;J<D;J++)U[J]=u1(J,F);return U}var P1=new Map,R1=new Map;function m1(D){let F=P1.get(D);if(!F)F=c1(D),P1.set(D,F);return F}function p1(D,F){let U=`${D}_${F?1:0}`,J=R1.get(U);if(!J){let Q=D*2;J=new Float64Array(D*2);let $=(F?1:-1)*Math.PI/D;for(let K=0;K<D;K++){let G=$*K;J[K*2]=Math.cos(G),J[K*2+1]=Math.sin(G)}R1.set(U,J)}return J}function M1(D,F,U,J=0,Q=1){let q=Math.log2(F)|0,$=m1(F);if(Q===1&&J===0)for(let K=0;K<F;K++){let G=$[K];if(G>K){let Z=K*2,_=G*2,H=D[Z];D[Z]=D[_],D[_]=H,H=D[Z+1],D[Z+1]=D[_+1],D[_+1]=H}}else{let K=new Float64Array(F*2);for(let G=0;G<F;G++){let Z=(J+G*Q)*2,_=$[G]*2;K[_]=D[Z],K[_+1]=D[Z+1]}for(let G=0;G<F;G++){let Z=(J+G*Q)*2;D[Z]=K[G*2],D[Z+1]=K[G*2+1]}}for(let K=1;K<=q;K++){let G=1<<K,Z=G>>1,_=p1(Z,U);for(let H=0;H<F;H+=G)for(let A=0;A<Z;A++){let E=(J+(H+A)*Q)*2,L=(J+(H+A+Z)*Q)*2,O=_[A*2],M=_[A*2+1],Y=D[L],T=D[L+1],k=O*Y-M*T,P=O*T+M*Y,j=D[E],W=D[E+1];D[E]=j+k,D[E+1]=W+P,D[L]=j-k,D[L+1]=W-P}}if(U){let K=1/F;for(let G=0;G<F;G++){let Z=(J+G*Q)*2;D[Z]*=K,D[Z+1]*=K}}}function K1(D,F,U){let J=new Float64Array(F*2);for(let q=0;q<F;q++){let $=q*F*2;J.set(D.subarray($,$+F*2)),M1(J,F,U),D.set(J,$)}let Q=new Float64Array(F*2);for(let q=0;q<F;q++){for(let $=0;$<F;$++)Q[$*2]=D[($*F+q)*2],Q[$*2+1]=D[($*F+q)*2+1];M1(Q,F,U);for(let $=0;$<F;$++)D[($*F+q)*2]=Q[$*2],D[($*F+q)*2+1]=Q[$*2+1]}}function q1(D,F){let U=F>>1;for(let J=0;J<U;J++)for(let Q=0;Q<F;Q++){let q=J+U,$=(Q+U)%F,K=(J*F+Q)*2,G=(q*F+$)*2,Z=D[K];D[K]=D[G],D[G]=Z,Z=D[K+1],D[K+1]=D[G+1],D[G+1]=Z}}function k1(D,F,U){let{wavelength:J,na:Q,sigma:q,defocus:$}=U,K=19.53125,G=1/(F*19.53125),_=Q*(1+q)/J,H=_*_,A=$*1000,E=Math.PI*J*A,L=F>>1;for(let O=0;O<F;O++){let M=(O-L)*G,Y=M*M;for(let T=0;T<F;T++){let k=(T-L)*G,P=k*k+Y,j=(O*F+T)*2;if(P>H)D[j]=0,D[j+1]=0;else if(A!==0){let W=E*P,w=Math.cos(W),y=Math.sin(W),V=D[j],R=D[j+1];D[j]=V*w-R*y,D[j+1]=V*y+R*w}}}}var g=256,m=g*g,n=null;function d1(){if(!n||n.length!==m*2)n=new Float64Array(m*2);return n}function s(D,F){let U=performance.now(),J=d1();for(let K=0;K<m;K++)J[K*2]=D[K],J[K*2+1]=0;K1(J,g,!1),q1(J,g),k1(J,g,F),q1(J,g),K1(J,g,!0);let Q=new Float32Array(m),q=0;for(let K=0;K<m;K++){let G=J[K*2],Z=J[K*2+1],_=G*G+Z*Z;if(Q[K]=_,_>q)q=_}if(q>0){let K=1/q;for(let G=0;G<m;G++)Q[G]*=K}let $=performance.now()-U;return{intensity:Q,timeMs:$}}var p=256,r1=19.53125;function C1(D,F,U){if(U===1)return[(D+F)/2];let J=[];for(let Q=0;Q<U;Q++)J.push(D+(F-D)*Q/(U-1));return J}function o1(D,F){let J=(p>>1)*p,Q=0,q=-1,$=-1;for(let K=0;K<=p;K++){let G=K<p&&D[J+K]*F>=1;if(G&&$<0)$=K;else if(!G&&$>=0){let Z=K-$,_=$+Z/2;if(Z>Q||Z===Q&&Math.abs(_-p/2)<Math.abs(q-p/2))Q=Z,q=_;$=-1}}return Q*r1}function w1(D,F,U){let J=performance.now(),Q=C1(U.focusRange[0],U.focusRange[1],U.focusSteps),q=C1(U.doseRange[0],U.doseRange[1],U.doseSteps),$=q.map((G)=>({dose:G,points:[]}));for(let G of Q){let Z={...F,defocus:G},_=s(D,Z);for(let H=0;H<q.length;H++){let A=o1(_.intensity,q[H]);$[H].points.push({focus:G,cd:A})}}let K=performance.now()-J;return{curves:$,focusValues:Q,doseValues:q,timeMs:K,pipelineRuns:Q.length}}function B1(){let D=document.getElementById("app"),{maskPanel:F,heatmapCanvas:U,paramsPanel:J,timingReadout:Q,zoomSlider:q,zoomInBtn:$,zoomOutBtn:K,zoomLabel:G,heatmapContainer:Z,downloadBtn:_,bossungCanvas:H,bossungChartContainer:A}=G1(D),E=H1(F),L=document.createElement("div");J.insertBefore(L,J.firstChild),X1(L,(V)=>{U.style.width=V+"px",U.style.height=V+"px"});let O=document.createElement("div");O.style.padding="10px 0",J.insertBefore(O,Q),Y1(O);let M=document.createElement("div");J.insertBefore(M,Q);let Y=new $1(H),T=L1(M,(V)=>{T.setRunning(!0),setTimeout(()=>{let R=h(),C=w1(R.mask,R.params,V);Y.draw(C),T.setTiming(C.timeMs,C.pipelineRuns),T.setRunning(!1);let S=A._showBossung;if(S)S()},0)}),k=new Q1(U),P=document.getElementById("timing-sim"),j=document.getElementById("timing-render");_1((V)=>{let R=s(V.mask,V.params);P.textContent=R.timeMs.toFixed(1);let C=performance.now();k.draw(R.intensity);let S=performance.now()-C;j.textContent=S.toFixed(1)});let W=0;function w(V){if(W===0)W=U.offsetWidth;if(V===1)U.style.width="",U.style.height="",U.style.maxWidth="",U.style.maxHeight="",U.style.minWidth="",U.style.minHeight="";else{let R=W*V;U.style.width=`${R}px`,U.style.height=`${R}px`,U.style.maxWidth="none",U.style.maxHeight="none",U.style.minWidth=`${R}px`,U.style.minHeight=`${R}px`}G.textContent=`${Math.round(V*100)}%`,q.value=String(V)}q.addEventListener("input",()=>{w(parseFloat(q.value))}),K.addEventListener("click",()=>{let V=Math.max(0.5,parseFloat(q.value)-0.1);w(Math.round(V*10)/10)}),$.addEventListener("click",()=>{let V=Math.min(4,parseFloat(q.value)+0.1);w(Math.round(V*10)/10)}),_.addEventListener("click",()=>{let V=document.createElement("a"),R=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19);V.download=`lithography-simulation-${R}.png`,V.href=U.toDataURL("image/png"),V.click()});let y=F.querySelector(".preset-btn");if(y)y.click()}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",B1);else B1();
