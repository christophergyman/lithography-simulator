function m(G){G.innerHTML="";let U=document.createElement("div");U.className="header";let L=document.createElement("h1");L.textContent="Lithography Simulator";let F=document.createElement("span");F.className="subtitle",F.textContent="Fourier Optics / Aerial Image",U.append(L,F);let D=document.createElement("div");D.className="panel";let E=document.createElement("div");E.className="panel panel-heatmap";let J=document.createElement("div");J.className="heatmap-container";let A=document.createElement("canvas");J.appendChild(A),E.appendChild(J);let _=document.createElement("div");_.className="panel panel-params";let Q=document.createElement("div");Q.className="panel-title",Q.textContent="Parameters",_.appendChild(Q);let $=document.createElement("div");return $.className="timing-readout",$.innerHTML=`
    FFT + Pupil: <span class="value" id="timing-sim">—</span> ms<br>
    Render: <span class="value" id="timing-render">—</span> ms
  `,_.appendChild($),G.append(U,D,E,_),{maskPanel:D,heatmapCanvas:A,paramsPanel:_,timingReadout:$}}var c=[],S=!1,w={mask:new Float32Array(65536),params:{wavelength:248,na:0.75,sigma:0.5,defocus:0}};function n(){if(S)return;S=!0,requestAnimationFrame(()=>{S=!1;for(let G of c)G(w)})}function R(){return w}function f(G){c.push(G)}function z(G){w.mask=G,n()}function g(G,U){w.params[G]=U,n()}function y(){return new Float32Array(65536)}function L1(){let G=y(),U=10,L=5;for(let F=0;F<256;F++)for(let D=0;D<256;D++)if(D%10<5)G[F*256+D]=1;return G}function _1(){let G=y(),U=20,L=6,F=Math.floor(7);for(let D=0;D<256;D++)for(let E=0;E<256;E++){let J=D%20,A=E%20;if(J>=F&&J<F+6&&A>=F&&A<F+6)G[D*256+E]=1}return G}function A1(){let G=y(),U=6,L=125,F=131;for(let D=0;D<256;D++)for(let E=125;E<131;E++)G[D*256+E]=1;return G}function E1(){let G=y(),U=5,L=2;for(let F=0;F<256;F++)for(let D=0;D<256;D++)if(D%5<2)G[F*256+D]=1;return G}function J1(){let G=y(),U=128,L=128,F=60,D=10;for(let E=0;E<256;E++)for(let J=0;J<256;J++){let A=E-128,_=J-128,Q=_>=0&&_<60&&A>=-5&&A<5,$=A>=0&&A<60&&_>=-5&&_<5;if(Q||$)G[E*256+J]=1}return G}var N=[{name:"line_space",label:"Line/Space (10px)",generate:L1},{name:"contacts",label:"Contact Holes",generate:_1},{name:"isolated_line",label:"Isolated Line",generate:A1},{name:"dense_lines",label:"Dense Lines (5px)",generate:E1},{name:"l_shape",label:"L-Shape Corner",generate:J1}];var W=256,r=256;function s(G){let U=document.createElement("div");U.className="panel-title",U.textContent="Mask Editor",G.appendChild(U);let L=document.createElement("div");L.className="panel-mask",G.appendChild(L);let F=document.createElement("div");F.className="mask-canvas-wrap";let D=document.createElement("canvas");D.width=W,D.height=W,D.style.width=r+"px",D.style.height=r+"px",F.appendChild(D),L.appendChild(F);let E=D.getContext("2d"),J=!1,A=1;function _(){let K=R().mask,H=E.createImageData(W,W),X=H.data;for(let V=0;V<W*W;V++){let O=K[V]>0?255:0;X[V*4]=O,X[V*4+1]=O,X[V*4+2]=O,X[V*4+3]=255}E.putImageData(H,0,0)}function Q(K){let H=D.getBoundingClientRect(),X=W/H.width,V=W/H.height,O=Math.floor((K.clientX-H.left)*X),q=Math.floor((K.clientY-H.top)*V);return[Math.max(0,Math.min(W-1,O)),Math.max(0,Math.min(W-1,q))]}function $(K){let[H,X]=Q(K),V=R().mask;for(let O=-1;O<=1;O++)for(let q=-1;q<=1;q++){let C=H+q,M=X+O;if(C>=0&&C<W&&M>=0&&M<W)V[M*W+C]=A}_(),z(V)}D.addEventListener("mousedown",(K)=>{J=!0;let[H,X]=Q(K);A=K.button===2?0:R().mask[X*W+H]>0?0:1,$(K)}),D.addEventListener("mousemove",(K)=>{if(J)$(K)}),D.addEventListener("mouseup",()=>{J=!1}),D.addEventListener("mouseleave",()=>{J=!1}),D.addEventListener("contextmenu",(K)=>K.preventDefault());let Z=document.createElement("div");Z.className="preset-buttons";let Y=null;for(let K of N){let H=document.createElement("button");H.className="preset-btn",H.textContent=K.label,H.addEventListener("click",()=>{let X=K.generate();if(z(X),_(),Y)Y.classList.remove("active");H.classList.add("active"),Y=H}),Z.appendChild(H)}L.appendChild(Z);let j=document.createElement("div");j.className="mask-tools";let u=document.createElement("button");u.textContent="CLEAR",u.addEventListener("click",()=>{if(z(new Float32Array(W*W)),_(),Y)Y.classList.remove("active");Y=null});let T=document.createElement("button");T.textContent="INVERT",T.addEventListener("click",()=>{let K=R().mask;for(let H=0;H<W*W;H++)K[H]=K[H]>0?0:1;z(K),_()}),j.append(u,T),L.appendChild(j),_()}var Q1=[{key:"wavelength",label:"Wavelength",unit:"nm",min:193,max:365,step:1,decimals:0},{key:"na",label:"NA",unit:"",min:0.1,max:1.4,step:0.01,decimals:2},{key:"sigma",label:"Sigma (σ)",unit:"",min:0,max:1,step:0.01,decimals:2},{key:"defocus",label:"Defocus",unit:"μm",min:-2,max:2,step:0.01,decimals:2}];function l(G){for(let U of Q1){let L=document.createElement("div");L.className="param-group";let F=document.createElement("div");F.className="param-label";let D=document.createElement("span");D.className="param-name",D.textContent=U.label;let E=document.createElement("span"),J=document.createElement("span");J.className="param-value";let A=document.createElement("span");A.className="param-unit",A.textContent=U.unit,E.append(J,A),F.append(D,E);let _=document.createElement("input");_.type="range",_.min=String(U.min),_.max=String(U.max),_.step=String(U.step),_.value=String(R().params[U.key]);let Q=($)=>{J.textContent=$.toFixed(U.decimals)};Q(R().params[U.key]),_.addEventListener("input",()=>{let $=parseFloat(_.value);Q($),g(U.key,$)}),L.append(F,_),G.appendChild(L)}}var i=`#version 300 es
precision highp float;

// Fullscreen triangle trick — 3 vertices, no buffers needed
const vec2 positions[3] = vec2[3](
  vec2(-1.0, -1.0),
  vec2( 3.0, -1.0),
  vec2(-1.0,  3.0)
);

out vec2 vUV;

void main() {
  vec2 pos = positions[gl_VertexID];
  vUV = pos * 0.5 + 0.5;
  gl_Position = vec4(pos, 0.0, 1.0);
}
`,d=`#version 300 es
precision highp float;

uniform sampler2D uIntensity;  // R32F intensity data
uniform sampler2D uColormap;   // 256x1 RGBA viridis lookup

in vec2 vUV;
out vec4 fragColor;

void main() {
  float val = texture(uIntensity, vUV).r;
  val = clamp(val, 0.0, 1.0);
  fragColor = texture(uColormap, vec2(val, 0.5));
}
`;var $1=[[68,1,84],[68,2,86],[69,4,87],[69,5,89],[70,7,90],[70,8,92],[70,10,93],[70,11,94],[71,13,96],[71,14,97],[71,16,99],[71,17,100],[71,19,101],[72,20,103],[72,22,104],[72,23,105],[72,24,106],[72,26,108],[72,27,109],[72,28,110],[72,29,111],[72,31,112],[72,32,113],[72,33,115],[72,35,116],[72,36,117],[72,37,118],[72,38,119],[72,40,120],[72,41,121],[71,42,122],[71,44,122],[71,45,123],[71,46,124],[71,47,125],[70,48,126],[70,50,126],[70,51,127],[69,52,128],[69,53,129],[69,55,129],[68,56,130],[68,57,131],[68,58,131],[67,60,132],[67,61,132],[66,62,133],[66,63,133],[66,64,134],[65,66,134],[65,67,135],[64,68,135],[64,69,136],[63,71,136],[63,72,137],[62,73,137],[62,74,137],[62,76,138],[61,77,138],[61,78,138],[60,79,139],[60,80,139],[59,82,139],[59,83,140],[58,84,140],[58,85,140],[57,86,140],[57,87,141],[56,88,141],[56,90,141],[55,91,141],[55,92,141],[54,93,141],[54,94,142],[53,95,142],[53,96,142],[52,97,142],[52,98,142],[51,99,142],[51,100,142],[50,101,142],[50,102,142],[49,103,142],[49,104,142],[49,105,142],[48,106,142],[48,107,142],[47,108,142],[47,109,142],[46,110,142],[46,111,142],[46,112,142],[45,113,142],[45,114,142],[44,115,142],[44,116,141],[44,117,141],[43,118,141],[43,119,141],[42,120,141],[42,121,141],[42,122,141],[41,123,140],[41,124,140],[40,125,140],[40,126,140],[40,127,140],[39,128,139],[39,129,139],[39,130,139],[38,131,139],[38,132,139],[37,133,138],[37,134,138],[37,135,138],[36,136,138],[36,137,137],[36,138,137],[35,139,137],[35,140,136],[35,141,136],[34,142,136],[34,143,135],[34,144,135],[33,145,135],[33,146,134],[33,147,134],[33,148,133],[32,149,133],[32,150,133],[32,151,132],[32,152,132],[31,153,131],[31,154,131],[31,155,130],[31,156,130],[31,157,129],[31,158,129],[30,159,128],[30,160,128],[30,161,127],[30,162,127],[30,163,126],[30,164,126],[30,165,125],[30,166,124],[30,167,124],[31,168,123],[31,169,123],[31,170,122],[31,171,121],[31,172,121],[32,173,120],[32,174,119],[33,175,119],[33,176,118],[33,177,117],[34,178,117],[34,179,116],[35,180,115],[35,181,114],[36,182,114],[36,183,113],[37,184,112],[38,185,111],[38,186,111],[39,187,110],[40,188,109],[41,189,108],[41,190,107],[42,191,106],[43,192,106],[44,193,105],[45,194,104],[46,195,103],[47,196,102],[48,197,101],[49,198,100],[50,199,99],[52,200,98],[53,201,97],[54,202,96],[56,203,95],[57,204,94],[59,205,93],[60,206,92],[62,207,91],[63,208,90],[65,209,89],[67,210,87],[68,210,86],[70,211,85],[72,212,84],[74,213,83],[75,214,81],[77,214,80],[79,215,79],[81,216,78],[83,217,76],[85,217,75],[87,218,74],[89,219,72],[91,219,71],[93,220,70],[95,221,68],[97,221,67],[99,222,65],[101,222,64],[104,223,63],[106,223,61],[108,224,60],[110,224,58],[112,225,57],[115,225,55],[117,226,54],[119,226,52],[121,227,51],[124,227,49],[126,228,48],[128,228,46],[131,229,45],[133,229,43],[135,229,42],[138,230,40],[140,230,39],[142,231,37],[145,231,36],[147,231,34],[150,232,33],[152,232,31],[155,232,30],[157,233,28],[159,233,27],[162,233,25],[164,234,24],[167,234,23],[169,234,21],[172,235,20],[174,235,19],[177,235,18],[179,235,17],[182,236,16],[184,236,15],[187,236,14],[189,236,14],[192,237,13],[194,237,13],[197,237,13],[199,237,13],[201,237,13],[204,238,14],[206,238,14],[209,238,15],[211,238,16],[213,238,17],[216,239,18]];function e(){let G=new Uint8Array(1024);for(let U=0;U<256;U++){let L=$1[U];G[U*4+0]=L[0],G[U*4+1]=L[1],G[U*4+2]=L[2],G[U*4+3]=255}return G}var I=256;class v{gl;program;intensityTex;colormapTex;vao;constructor(G){G.width=I,G.height=I;let U=G.getContext("webgl2",{antialias:!1,alpha:!1,premultipliedAlpha:!1});if(!U)throw Error("WebGL2 not supported");this.gl=U;let L=U.getExtension("EXT_color_buffer_float");this.program=this.createProgram(i,d),this.vao=U.createVertexArray(),this.intensityTex=U.createTexture(),U.bindTexture(U.TEXTURE_2D,this.intensityTex),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.NEAREST),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.NEAREST),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_WRAP_S,U.CLAMP_TO_EDGE),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_WRAP_T,U.CLAMP_TO_EDGE),U.texImage2D(U.TEXTURE_2D,0,U.R32F,I,I,0,U.RED,U.FLOAT,null),this.colormapTex=U.createTexture(),U.bindTexture(U.TEXTURE_2D,this.colormapTex),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_WRAP_S,U.CLAMP_TO_EDGE),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_WRAP_T,U.CLAMP_TO_EDGE);let F=e();U.texImage2D(U.TEXTURE_2D,0,U.RGBA,256,1,0,U.RGBA,U.UNSIGNED_BYTE,F),U.useProgram(this.program),U.uniform1i(U.getUniformLocation(this.program,"uIntensity"),0),U.uniform1i(U.getUniformLocation(this.program,"uColormap"),1)}draw(G){let U=this.gl;U.activeTexture(U.TEXTURE0),U.bindTexture(U.TEXTURE_2D,this.intensityTex),U.texSubImage2D(U.TEXTURE_2D,0,0,0,I,I,U.RED,U.FLOAT,G),U.activeTexture(U.TEXTURE1),U.bindTexture(U.TEXTURE_2D,this.colormapTex),U.useProgram(this.program),U.bindVertexArray(this.vao),U.viewport(0,0,I,I),U.drawArrays(U.TRIANGLES,0,3)}resize(G,U){}createProgram(G,U){let L=this.gl,F=this.compileShader(L.VERTEX_SHADER,G),D=this.compileShader(L.FRAGMENT_SHADER,U),E=L.createProgram();if(L.attachShader(E,F),L.attachShader(E,D),L.linkProgram(E),!L.getProgramParameter(E,L.LINK_STATUS)){let J=L.getProgramInfoLog(E);throw L.deleteProgram(E),Error("Shader link error: "+J)}return L.deleteShader(F),L.deleteShader(D),E}compileShader(G,U){let L=this.gl,F=L.createShader(G);if(L.shaderSource(F,U),L.compileShader(F),!L.getShaderParameter(F,L.COMPILE_STATUS)){let D=L.getShaderInfoLog(F);throw L.deleteShader(F),Error("Shader compile error: "+D)}return F}}function H1(G,U){let L=0;for(let F=0;F<U;F++)L=L<<1|G&1,G>>=1;return L}function K1(G){let U=Math.log2(G)|0,L=new Uint32Array(G);for(let F=0;F<G;F++)L[F]=H1(F,U);return L}var t=new Map,a=new Map;function X1(G){let U=t.get(G);if(!U)U=K1(G),t.set(G,U);return U}function Y1(G,U){let L=`${G}_${U?1:0}`,F=a.get(L);if(!F){let D=G*2;F=new Float64Array(G*2);let J=(U?1:-1)*Math.PI/G;for(let A=0;A<G;A++){let _=J*A;F[A*2]=Math.cos(_),F[A*2+1]=Math.sin(_)}a.set(L,F)}return F}function U1(G,U,L,F=0,D=1){let E=Math.log2(U)|0,J=X1(U);if(D===1&&F===0)for(let A=0;A<U;A++){let _=J[A];if(_>A){let Q=A*2,$=_*2,Z=G[Q];G[Q]=G[$],G[$]=Z,Z=G[Q+1],G[Q+1]=G[$+1],G[$+1]=Z}}else{let A=new Float64Array(U*2);for(let _=0;_<U;_++){let Q=(F+_*D)*2,$=J[_]*2;A[$]=G[Q],A[$+1]=G[Q+1]}for(let _=0;_<U;_++){let Q=(F+_*D)*2;G[Q]=A[_*2],G[Q+1]=A[_*2+1]}}for(let A=1;A<=E;A++){let _=1<<A,Q=_>>1,$=Y1(Q,L);for(let Z=0;Z<U;Z+=_)for(let Y=0;Y<Q;Y++){let j=(F+(Z+Y)*D)*2,u=(F+(Z+Y+Q)*D)*2,T=$[Y*2],K=$[Y*2+1],H=G[u],X=G[u+1],V=T*H-K*X,O=T*X+K*H,q=G[j],C=G[j+1];G[j]=q+V,G[j+1]=C+O,G[u]=q-V,G[u+1]=C-O}}if(L){let A=1/U;for(let _=0;_<U;_++){let Q=(F+_*D)*2;G[Q]*=A,G[Q+1]*=A}}}function x(G,U,L){let F=new Float64Array(U*2);for(let E=0;E<U;E++){let J=E*U*2;F.set(G.subarray(J,J+U*2)),U1(F,U,L),G.set(F,J)}let D=new Float64Array(U*2);for(let E=0;E<U;E++){for(let J=0;J<U;J++)D[J*2]=G[(J*U+E)*2],D[J*2+1]=G[(J*U+E)*2+1];U1(D,U,L);for(let J=0;J<U;J++)G[(J*U+E)*2]=D[J*2],G[(J*U+E)*2+1]=D[J*2+1]}}function h(G,U){let L=U>>1;for(let F=0;F<L;F++)for(let D=0;D<U;D++){let E=F+L,J=(D+L)%U,A=(F*U+D)*2,_=(E*U+J)*2,Q=G[A];G[A]=G[_],G[_]=Q,Q=G[A+1],G[A+1]=G[_+1],G[_+1]=Q}}function G1(G,U,L){let{wavelength:F,na:D,sigma:E,defocus:J}=L,A=19.53125,_=1/(U*19.53125),$=D*(1+E)/F,Z=$*$,Y=J*1000,j=Math.PI*F*Y,u=U>>1;for(let T=0;T<U;T++){let K=(T-u)*_,H=K*K;for(let X=0;X<U;X++){let V=(X-u)*_,O=V*V+H,q=(T*U+X)*2;if(O>Z)G[q]=0,G[q+1]=0;else if(Y!==0){let C=j*O,M=Math.cos(C),p=Math.sin(C),k=G[q],o=G[q+1];G[q]=k*M-o*p,G[q+1]=k*p+o*M}}}}var b=256,P=b*b,B=null;function V1(){if(!B||B.length!==P*2)B=new Float64Array(P*2);return B}function F1(G,U){let L=performance.now(),F=V1();for(let A=0;A<P;A++)F[A*2]=G[A],F[A*2+1]=0;x(F,b,!1),h(F,b),G1(F,b,U),h(F,b),x(F,b,!0);let D=new Float32Array(P),E=0;for(let A=0;A<P;A++){let _=F[A*2],Q=F[A*2+1],$=_*_+Q*Q;if(D[A]=$,$>E)E=$}if(E>0){let A=1/E;for(let _=0;_<P;_++)D[_]*=A}let J=performance.now()-L;return{intensity:D,timeMs:J}}function D1(){let G=document.getElementById("app"),{maskPanel:U,heatmapCanvas:L,paramsPanel:F,timingReadout:D}=m(G);s(U);let E=document.createElement("div");E.style.padding="10px 0",F.insertBefore(E,D),l(E);let J=new v(L),A=document.getElementById("timing-sim"),_=document.getElementById("timing-render");f(($)=>{let Z=F1($.mask,$.params);A.textContent=Z.timeMs.toFixed(1);let Y=performance.now();J.draw(Z.intensity);let j=performance.now()-Y;_.textContent=j.toFixed(1)});let Q=U.querySelector(".preset-btn");if(Q)Q.click()}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",D1);else D1();
